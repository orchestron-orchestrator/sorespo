import file
import process

import orchestron.build
import orchestron.yang as oyang
import tmf.yang
from transform_list_order import remove_list_user_order
from transform_filter_schema import filter_schema

actor main(env):
    fc = file.FileCap(env.cap)
    pc = process.ProcessCap(env.cap)

    orchestron.build.apply_schema_transforms_to_dir(fc, "yang/CiscoIosXr_24_1_ncs55a1", [
        orchestron.build.SchemaTransformChain(".*yang.orig", [orchestron.build.SchemaTransformNoComments()])
    ])
    orchestron.build.apply_schema_transforms_to_dir(fc, "yang/NokiaSRLinux_25_3_2", [
        orchestron.build.SchemaTransformChain(".*yang.orig", [orchestron.build.SchemaTransformNoComments()])
    ])

    cfs_layer = orchestron.build.Layer.from_dir(fc, "yang/cfs")
    cfs_layer.models.extend([
        oyang.ietf_inet_types,
        tmf.yang.otmf.replace("TMF640_STORE_TRANSFORM", "sorespo.tmf.Tmf640Store"),
        tmf.yang.otmf640
    ])
    inter_layer = orchestron.build.Layer.from_dir(fc, "yang/inter")
    inter_layer.models.append(oyang.ietf_inet_types)
    rfs_layer = orchestron.build.Layer.from_dir(fc, "yang/rfs")
    rfs_layer.models.extend([oyang.rfs, oyang.ietf_inet_types])

    def transform_list_order(dt):
        paths = [
            "/jc:configuration/protocols/bgp/group/neighbor",
            "/jc:configuration/protocols/mpls/interface",
        ]
        remove_list_user_order(dt.root, paths)
        return dt

    def transform_filter(dt):
        # The original list of paths was auto-generated by comparing the old
        # (augmented junos-conf-root) with new (single junos-conf-root) model
        # and printing the common paths. The list here is a result of manual
        # pruning to include (approximately) what we actually use in rfs.act.
        # Optimized compile time from 50s to 5s.
        paths = [
    "/jc:configuration/interfaces/interface/description",
    "/jc:configuration/interfaces/interface/mac",
    "/jc:configuration/interfaces/interface/mtu",
    "/jc:configuration/interfaces/interface/name",
    "/jc:configuration/interfaces/interface/native-vlan-id",
    "/jc:configuration/interfaces/interface/unit/alias",
    "/jc:configuration/interfaces/interface/unit/description",
    "/jc:configuration/interfaces/interface/unit/encapsulation",
    "/jc:configuration/interfaces/interface/unit/family/inet",
    "/jc:configuration/interfaces/interface/unit/family/inet/address/name",
    "/jc:configuration/interfaces/interface/unit/family/inet6",
    "/jc:configuration/interfaces/interface/unit/family/inet6/address/name",
    "/jc:configuration/interfaces/interface/unit/family/iso",
    "/jc:configuration/interfaces/interface/unit/family/iso/address/name",
    "/jc:configuration/interfaces/interface/unit/mac",
    "/jc:configuration/interfaces/interface/unit/mtu",
    "/jc:configuration/interfaces/interface/unit/name",
    "/jc:configuration/interfaces/interface/unit/vlan-id",
    "/jc:configuration/protocols/bgp/group/authentication-algorithm",
    "/jc:configuration/protocols/bgp/group/authentication-key",
    "/jc:configuration/protocols/bgp/group/authentication-key-chain",
    "/jc:configuration/protocols/bgp/group/description",
    "/jc:configuration/protocols/bgp/group/export",
    "/jc:configuration/protocols/bgp/group/family/evpn/signaling",
    "/jc:configuration/protocols/bgp/group/family/inet-vpn/unicast",
    "/jc:configuration/protocols/bgp/group/family/inet6-vpn/unicast",
    "/jc:configuration/protocols/bgp/group/family/route-target",
    "/jc:configuration/protocols/bgp/group/hold-time",
    "/jc:configuration/protocols/bgp/group/local-address",
    "/jc:configuration/protocols/bgp/group/name",
    "/jc:configuration/protocols/bgp/group/neighbor/description",
    "/jc:configuration/protocols/bgp/group/neighbor/name",
    "/jc:configuration/protocols/bgp/group/neighbor/passive",
    "/jc:configuration/protocols/bgp/group/tcp-mss",
    "/jc:configuration/protocols/bgp/group/tcpao-auth-mismatch",
    "/jc:configuration/protocols/bgp/group/type",
    "/jc:configuration/protocols/bgp/log-updown",
    "/jc:configuration/protocols/isis/interface/family/name",
    "/jc:configuration/protocols/isis/interface/ldp-synchronization",
    "/jc:configuration/protocols/isis/interface/ldp-synchronization/disable",
    "/jc:configuration/protocols/isis/interface/ldp-synchronization/hold-time",
    "/jc:configuration/protocols/isis/interface/level/disable",
    "/jc:configuration/protocols/isis/interface/level/metric",
    "/jc:configuration/protocols/isis/interface/level/name",
    "/jc:configuration/protocols/isis/interface/lsp-interval",
    "/jc:configuration/protocols/isis/interface/name",
    "/jc:configuration/protocols/isis/interface/passive",
    "/jc:configuration/protocols/isis/interface/passive/remote-node-id",
    "/jc:configuration/protocols/isis/interface/passive/remote-node-iso",
    "/jc:configuration/protocols/isis/interface/point-to-point",
    "/jc:configuration/protocols/isis/level/authentication-key",
    "/jc:configuration/protocols/isis/level/authentication-type",
    "/jc:configuration/protocols/isis/level/disable",
    "/jc:configuration/protocols/isis/level/name",
    "/jc:configuration/protocols/isis/level/no-csnp-authentication",
    "/jc:configuration/protocols/isis/level/no-hello-authentication",
    "/jc:configuration/protocols/isis/level/no-psnp-authentication",
    "/jc:configuration/protocols/isis/level/wide-metrics-only",
    "/jc:configuration/protocols/isis/lsp-lifetime",
    "/jc:configuration/protocols/ldp/interface/disable",
    "/jc:configuration/protocols/ldp/interface/hello-interval",
    "/jc:configuration/protocols/ldp/interface/hold-time",
    "/jc:configuration/protocols/ldp/interface/name",
    "/jc:configuration/protocols/ldp/interface/transport-address",
    "/jc:configuration/protocols/ldp/preference",
    "/jc:configuration/protocols/ldp/transport-address",
    "/jc:configuration/protocols/mpls/interface/disable",
    "/jc:configuration/protocols/mpls/interface/name",
    "/jc:configuration/protocols/mpls/no-propagate-ttl",
    "/jc:configuration/rcsid",
    "/jc:configuration/routing-instances/instance/instance-type",
    "/jc:configuration/routing-instances/instance/interface/any",
    "/jc:configuration/routing-instances/instance/interface/multicast",
    "/jc:configuration/routing-instances/instance/interface/name",
    "/jc:configuration/routing-instances/instance/interface/primary",
    "/jc:configuration/routing-instances/instance/interface/unicast",
    "/jc:configuration/routing-instances/instance/name",
    "/jc:configuration/routing-instances/instance/protocols/bgp/group/export",
    "/jc:configuration/routing-instances/instance/protocols/bgp/group/import",
    "/jc:configuration/routing-instances/instance/protocols/bgp/group/name",
    "/jc:configuration/routing-instances/instance/protocols/bgp/group/neighbor/as-override",
    "/jc:configuration/routing-instances/instance/protocols/bgp/group/neighbor/authentication-algorithm",
    "/jc:configuration/routing-instances/instance/protocols/bgp/group/neighbor/authentication-key",
    "/jc:configuration/routing-instances/instance/protocols/bgp/group/neighbor/description",
    "/jc:configuration/routing-instances/instance/protocols/bgp/group/neighbor/multihop",
    "/jc:configuration/routing-instances/instance/protocols/bgp/group/neighbor/multihop/no-nexthop-change",
    "/jc:configuration/routing-instances/instance/protocols/bgp/group/neighbor/multihop/ttl",
    "/jc:configuration/routing-instances/instance/protocols/bgp/group/neighbor/name",
    "/jc:configuration/routing-instances/instance/protocols/bgp/group/neighbor/peer-as",
    "/jc:configuration/routing-instances/instance/protocols/bgp/group/passive",
    "/jc:configuration/routing-instances/instance/route-distinguisher",
    "/jc:configuration/routing-instances/instance/vrf-table-label",
    "/jc:configuration/routing-instances/instance/vrf-target/auto",
    "/jc:configuration/routing-instances/instance/vrf-target/community",
    "/jc:configuration/routing-instances/instance/vrf-target/export",
    "/jc:configuration/routing-instances/instance/vrf-target/import",
    "/jc:configuration/routing-options/autonomous-system/as-number",
    "/jc:configuration/system/host-name",
    "/jc:configuration/system/services",
    "/jc:configuration/system/services/netconf/rfc-compliant",
    "/jc:configuration/system/services/netconf/yang-compliant",
    "/jc:configuration/version",
    # Junos Spine Switch base, may be duplicate of above lines
    "/jc:configuration/banner",
    "/jc:configuration/event-options/policy/attributes-match",
    "/jc:configuration/event-options/policy/attributes-match/condition",
    "/jc:configuration/event-options/policy/attributes-match/from-event-attribute",
    "/jc:configuration/event-options/policy/attributes-match/to-event-attribute-value",
    "/jc:configuration/event-options/policy/events",
    "/jc:configuration/event-options/policy/name",
    "/jc:configuration/event-options/policy/then",
    "/jc:configuration/event-options/policy/then/execute-commands",
    "/jc:configuration/event-options/policy/then/execute-commands/commands",
    "/jc:configuration/event-options/policy/then/execute-commands/commands/name",
    "/jc:configuration/event-options/policy/then/raise-trap",
    "/jc:configuration/event-options/policy/within",
    "/jc:configuration/event-options/policy/within/name",
    "/jc:configuration/event-options/policy/within/trigger",
    "/jc:configuration/event-options/policy/within/trigger/count",
    "/jc:configuration/event-options/policy/within/trigger/on",
    "/jc:configuration/firewall/family/inet/filter/name",
    "/jc:configuration/firewall/family/inet/filter/term",
    "/jc:configuration/firewall/family/inet/filter/term/from",
    "/jc:configuration/firewall/family/inet/filter/term/from/destination-port",
    "/jc:configuration/firewall/family/inet/filter/term/from/icmp-type",
    "/jc:configuration/firewall/family/inet/filter/term/from/protocol",
    "/jc:configuration/firewall/family/inet/filter/term/from/source-port",
    "/jc:configuration/firewall/family/inet/filter/term/name",
    "/jc:configuration/firewall/family/inet/filter/term/then",
    "/jc:configuration/firewall/family/inet/filter/term/then/accept",
    "/jc:configuration/firewall/family/inet/filter/term/then/count",
    "/jc:configuration/firewall/family/inet/filter/term/then/discard",
    "/jc:configuration/firewall/family/inet/filter/term/then/syslog",
    "/jc:configuration/interfaces/interface/description",
    "/jc:configuration/interfaces/interface/mtu",
    "/jc:configuration/interfaces/interface/name",
    "/jc:configuration/interfaces/interface/unit/description",
    "/jc:configuration/interfaces/interface/unit/family/inet/address/name",
    "/jc:configuration/interfaces/interface/unit/family/inet/filter",
    "/jc:configuration/interfaces/interface/unit/family/inet/filter/input",
    "/jc:configuration/interfaces/interface/unit/family/inet/filter/input/filter-name",
    "/jc:configuration/interfaces/interface/unit/name",
    "/jc:configuration/policy-options/policy-statement/name",
    "/jc:configuration/policy-options/policy-statement/then",
    "/jc:configuration/policy-options/policy-statement/then/load-balance",
    "/jc:configuration/policy-options/policy-statement/then/load-balance/per-packet",
    "/jc:configuration/policy-options/prefix-list/apply-path",
    "/jc:configuration/policy-options/prefix-list/name",
    "/jc:configuration/policy-options/prefix-list/prefix-list-item/name",
    "/jc:configuration/protocols/lldp-med/interface/disable",
    "/jc:configuration/protocols/lldp-med/interface/name",
    "/jc:configuration/protocols/lldp/interface/disable",
    "/jc:configuration/protocols/lldp/interface/name",
    "/jc:configuration/protocols/ospf/area/interface/authentication",
    "/jc:configuration/protocols/ospf/area/interface/authentication/md5",
    "/jc:configuration/protocols/ospf/area/interface/authentication/md5/key",
    "/jc:configuration/protocols/ospf/area/interface/authentication/md5/name",
    "/jc:configuration/protocols/ospf/area/interface/bfd-liveness-detection",
    "/jc:configuration/protocols/ospf/area/interface/bfd-liveness-detection/full-neighbors-only",
    "/jc:configuration/protocols/ospf/area/interface/bfd-liveness-detection/minimum-interval",
    "/jc:configuration/protocols/ospf/area/interface/bfd-liveness-detection/multiplier",
    "/jc:configuration/protocols/ospf/area/interface/interface-type",
    "/jc:configuration/protocols/ospf/area/interface/name",
    "/jc:configuration/protocols/ospf/area/interface/passive",
    "/jc:configuration/protocols/ospf/area/name",
    "/jc:configuration/protocols/ospf/external-preference",
    "/jc:configuration/protocols/ospf/overload/timeout",
    "/jc:configuration/protocols/ospf/preference",
    "/jc:configuration/protocols/ospf/reference-bandwidth",
    "/jc:configuration/protocols/ospf/spf-options/rapid-runs",
    "/jc:configuration/routing-instances/instance/name",
    "/jc:configuration/routing-instances/instance/routing-options/static/route/name",
    "/jc:configuration/routing-instances/instance/routing-options/static/route/next-hop",
    "/jc:configuration/routing-instances/instance/routing-options/static/route/no-readvertise",
    "/jc:configuration/routing-instances/instance/routing-options/static/route/retain",
    "/jc:configuration/routing-options/forwarding-table/export",
    "/jc:configuration/routing-options/router-id",
    "/jc:configuration/system/accounting/destination/tacplus",
    "/jc:configuration/system/accounting/events",
    "/jc:configuration/system/arp/aging-timer",
    "/jc:configuration/system/authentication-order",
    "/jc:configuration/system/compress-configuration-files",
    "/jc:configuration/system/domain-name",
    "/jc:configuration/system/host-name",
    "/jc:configuration/system/internet-options",
    "/jc:configuration/system/internet-options/path-mtu-discovery",
    "/jc:configuration/system/login/class/allow-commands",
    "/jc:configuration/system/login/class/deny-commands",
    "/jc:configuration/system/login/class/idle-timeout",
    "/jc:configuration/system/login/class/name",
    "/jc:configuration/system/login/class/permissions",
    "/jc:configuration/system/login/message",
    "/jc:configuration/system/login/user/authentication",
    "/jc:configuration/system/login/user/authentication/encrypted-password",
    "/jc:configuration/system/login/user/class",
    "/jc:configuration/system/login/user/full-name",
    "/jc:configuration/system/login/user/name",
    "/jc:configuration/system/login/user/uid",
    "/jc:configuration/system/management-instance",
    "/jc:configuration/system/no-ping-record-route",
    "/jc:configuration/system/no-ping-time-stamp",
    "/jc:configuration/system/no-redirects-ipv6",
    "/jc:configuration/system/ports/console/log-out-on-disconnect",
    "/jc:configuration/system/root-authentication/encrypted-password",
    "/jc:configuration/system/services/netconf/ssh",
    "/jc:configuration/system/services/ssh/client-alive-count-max",
    "/jc:configuration/system/services/ssh/client-alive-interval",
    "/jc:configuration/system/services/ssh/connection-limit",
    "/jc:configuration/system/services/ssh/max-sessions-per-connection",
    "/jc:configuration/system/services/ssh/protocol-version",
    "/jc:configuration/system/services/ssh/rate-limit",
    "/jc:configuration/system/services/ssh/root-login",
    "/jc:configuration/system/services/ssh/sftp-server",
    "/jc:configuration/system/syslog/archive/files",
    "/jc:configuration/system/syslog/archive/size",
    "/jc:configuration/system/syslog/archive/world-readable",
    "/jc:configuration/system/syslog/file/archive",
    "/jc:configuration/system/syslog/file/archive/size",
    "/jc:configuration/system/syslog/file/contents",
    "/jc:configuration/system/syslog/file/contents/any",
    "/jc:configuration/system/syslog/file/contents/critical",
    "/jc:configuration/system/syslog/file/contents/info",
    "/jc:configuration/system/syslog/file/contents/name",
    "/jc:configuration/system/syslog/file/contents/notice",
    "/jc:configuration/system/syslog/file/explicit-priority",
    "/jc:configuration/system/syslog/file/name",
    "/jc:configuration/system/syslog/host/contents",
    "/jc:configuration/system/syslog/host/contents/info",
    "/jc:configuration/system/syslog/host/contents/name",
    "/jc:configuration/system/syslog/host/explicit-priority",
    "/jc:configuration/system/syslog/host/name",
    "/jc:configuration/system/syslog/host/source-address",
    "/jc:configuration/system/syslog/time-format",
    "/jc:configuration/system/syslog/time-format/millisecond",
    "/jc:configuration/system/syslog/user/contents",
    "/jc:configuration/system/syslog/user/contents/emergency",
    "/jc:configuration/system/syslog/user/contents/name",
    "/jc:configuration/system/syslog/user/name",
    "/jc:configuration/system/tacplus-options/strict-authorization",
    "/jc:configuration/system/tacplus-server/name",
    "/jc:configuration/system/tacplus-server/routing-instance",
    "/jc:configuration/system/tacplus-server/secret",
    "/jc:configuration/system/tacplus-server/single-connection",
    "/jc:configuration/system/tacplus-server/timeout",
    "/jc:configuration/system/time-zone",
    # end of Juniper Spine Switches
]
        filter_schema(dt.root, paths)
        return dt

    # The paths referenced by these leafrefs are invalid - missing module
    # imports. We explicitly allow resolving the target leaf type to fallback to
    # a string so that we can avoid adding more models here ...
    broken_leafrefs = [
        "/network-instance/protocols/isis/instance/export-policy",
        "/network-instance/protocols/isis/instance/authentication/keychain",
        "/network-instance/protocols/isis/instance/interface/level/authentication/keychain",
        "/network-instance/protocols/isis/instance/interface/authentication/keychain",
        "/network-instance/protocols/isis/instance/level/authentication/keychain",
        "/network-instance/protocols/bgp/authentication/keychain",
        "/network-instance/protocols/bgp/rib-management/table/route-table-import",
        "/network-instance/protocols/bgp/group/authentication/keychain",
        "/network-instance/protocols/bgp/group/send-default-route/export-policy",
        "/network-instance/protocols/bgp/neighbor/authentication/keychain",
        "/network-instance/protocols/bgp/neighbor/send-default-route/export-policy",
    ]

    spec = orchestron.build.SysSpec("sorespo", [
        cfs_layer,
        inter_layer,
        rfs_layer,
    ], [
        orchestron.build.DeviceType.from_dir(fc, "CiscoIosXr_24_1_ncs55a1", "yang/CiscoIosXr_24_1_ncs55a1"),
        orchestron.build.DeviceType.from_dir(fc, "JuniperCRPD_23_4R1_9", "yang/JuniperCRPD_23_4R1_9"),
        orchestron.build.DeviceType.from_dir(fc, "NokiaSRLinux_25_3_2", "yang/NokiaSRLinux_25_3_2"),
    ])
    compiled_spec = spec.compile(broken_leafrefs)
    transform_list_order(transform_filter(compiled_spec.dev_types["JuniperCRPD_23_4R1_9"]))
    compiled_spec.gen_app(fc, "../src/")

    env.exit(0)
